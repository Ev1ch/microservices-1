# Лабораторна робота №5.

### Тема: Асинхронний зв'язок між сервісами.

### Завдання:

1. Налаштувати *message broker*.
2. Розширити застосунок, додати асинхронну комунікацію (мінімум 3 сервіси, 2 топіки)

### 1. Налаштувати *message broker*

В прикладі буде використовуватись *Kafka*, у своїх проектах можна використовувати будь-який *message broker*.

#### 1.1 Підключення *kafka* в застосунок 

Для того, щоб додати *kafka* в застосунок, достатньо додати його в залежності в *Helm Chart*:

```yaml
dependencies:
  - name: kafka
    version: 18.3.1
    repository: https://charts.bitnami.com/bitnami
  ...
```

Потім виконати 

`helm dep update helm`
`helm dep build helm`
`helm upgrade local helm` (або `helm install local helm` якщо реліз не встановлено)

#### 1.2 Перевірка роботи *kafka*

Перевіримо роботу *kafka*, зайшовши на *Pod*:

```
kubectl exec -it pod/kafka-0 -- /bin/bash
```

Для того, щоб надіслати повідомлення можна використати скрипт `kafka-console-producer.sh`. Так як скрипт запускається на тому ж хості, що і *kafka* адреса брокера буде `127.0.0.1:9092`

```shell
kafka-console-producer.sh --broker-list 127.0.0.1:9092 --topic test
```

Після цього зчитати повідомлення можна виконавши наступну команду

```shell
kafka-console-consumer.sh --bootstrap-server 127.0.0.1:9092 --topic test --from-beginning
```

Для перевірки які черги (*topic*) створено, можемо використати `kafka-topics.sh`

```shell
kafka-topics.sh --list --bootstrap-server 127.0.0.1:9092
```

#### 1.2 Налаштування *kafka*

*kafka* буде працювати і за замовчуванням, але рекомендовано задати деякі налаштування:

```yaml
kafka:
  fullnameOverride: kafka       # ім'я сервісу (хост по якому можна звертатись до брокера)
  numPartitions: 3              # кількість розділів визначає скільки консьюмерів може бути в топіка одночасно  
  autoCreateTopicsEnable: false # заборонити автоматичне створення топіків, вони мають визначатись явно, в списку нижче
  provisioning:
    enabled: true               # при запуску будуть створені перелічені топіки
    topics:
     - name: demo
```

Зверніть увагу, що в *helm Chart* *kafka* за замовчуванням увімкнений *persistence* і всі данні зберігаються на диск.
Тобто після збоїв чи перезавантажень - надіслані повідомлення будуть зберігатись.

### 2. Розширити додаток

Тепер, коли сам *message broker* працює - потрібно розширити власні сервіси для взаємодії між собою.
Для прикладу в директорії *services* додано 2 нові сервіси `producer` і `consumer` та додано відповідні *Dockerfile* та *Helm Chart*.

Варіанти асинхронних задач, які можуть підійти для різного роду додатків:
1) нотифікації (браузер, пошта, смс)
2) аудит (збереження історії змін сутностей)
